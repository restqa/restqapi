#!/usr/bin/env node

const { program } = require('commander')
const path = require('path')
const cucumber = require('cucumber')

let package = require('../package.json')

program
  .version(package.version)
  .option('-c, --config <config>', 'Use a specific .restqa.yml file')

program.on('--help', () => {
  /* eslint-disable no-console */
  console.log(
    '  For more details please visit https://github.com/resqa/restqapi'
  )
  /* eslint-enable no-console */
})

program.parse(process.argv)

program.config = program.config || path.join(process.cwd(), '.restqa.yml')

let customOptions = [
  'node',
  'cucumber-js',
  '--require',
  './src',
  '--world-parameters',
  `{"configFile": "${program.config}"}`,
  '--format',
  './formatter/index.js:restqa-reports.txt',
]

let paths = program.args.map(_ => path.resolve(_))
if (!path.length) paths = [path.resolve('.')]

const options  = {
  argv: customOptions.concat(paths),
  cwd: path.join(__dirname, '../'),
  stdout: process.stdout
}

const cucumberCli = new cucumber.Cli(options);

cucumberCli.run()
  .then(result => {
    const exitCode = result.success ? 0 : 1
    if (result.shouldExitImmediately) {
      process.exit(exitCode)
    } else {
      process.exitCode = exitCode
    }
  })
  .catch(err => {
    console.error(err) // eslint-disable-line no-console
    process.exit(1)
  })
